<script>
    var cardData = {}; // Store fetched threads per card
    var AUTO_REFRESH_INTERVAL = 60000; // 60 seconds

    // Selection state for bulk actions
    var selectedThreads = {}; // { cardId: Set of threadIds }
    var selectionMode = false;

    // Undo queue
    var undoQueue = [];
    var UNDO_TIMEOUT = 8000; // 8 seconds to undo

    // Settings
    var settings = {
        cardWidth: 320,
        snippetLines: 2,
        actions: { archive: true, star: true, trash: true, markRead: false, markImportant: false, snooze: false }
    };

    function loadSettings() {
        var saved = localStorage.getItem("gmailCardsSettings");
        if (saved) {
            try {
                var parsed = JSON.parse(saved);
                settings = Object.assign(settings, parsed);
                settings.actions = Object.assign({ archive: true, star: true, trash: true, markRead: false, markImportant: false, snooze: false }, settings.actions || {});
            } catch (e) {}
        } else {
            var oldWidth = localStorage.getItem("cardWidth");
            if (oldWidth) { settings.cardWidth = parseInt(oldWidth) || 320; localStorage.removeItem("cardWidth"); }
        }
        applySettings();
    }

    function saveSettings() { localStorage.setItem("gmailCardsSettings", JSON.stringify(settings)); applySettings(); }

    function applySettings() {
        document.documentElement.style.setProperty("--card-width", settings.cardWidth + "px");
        document.getElementById("settingCardWidth").value = settings.cardWidth;
        document.getElementById("cardWidthValue").textContent = settings.cardWidth + "px";
        document.documentElement.style.setProperty("--snippet-lines", settings.snippetLines);
        document.getElementById("settingSnippetLines").value = settings.snippetLines;
        document.getElementById("snippetLinesValue").textContent = settings.snippetLines;
        document.getElementById("actionArchive").checked = settings.actions.archive;
        document.getElementById("actionStar").checked = settings.actions.star;
        document.getElementById("actionTrash").checked = settings.actions.trash;
        document.getElementById("actionMarkRead").checked = settings.actions.markRead;
        document.getElementById("actionMarkImportant").checked = settings.actions.markImportant;
        document.getElementById("actionSnooze").checked = settings.actions.snooze;
        cards.forEach(function (card) { if (!card.collapsed && cardData[card.id]) renderThreads(card.id); });
    }

    function toggleSettings() {
        var sidebar = document.getElementById("settingsSidebar");
        var overlay = document.getElementById("settingsOverlay");
        var isOpen = sidebar.classList.contains("open");
        sidebar.classList.toggle("open", !isOpen);
        overlay.classList.toggle("open", !isOpen);
    }

    function initSettingsListeners() {
        document.getElementById("settingCardWidth").addEventListener("input", function () {
            settings.cardWidth = parseInt(this.value) || 320;
            document.getElementById("cardWidthValue").textContent = settings.cardWidth + "px";
            document.documentElement.style.setProperty("--card-width", settings.cardWidth + "px");
        });
        document.getElementById("settingCardWidth").addEventListener("change", saveSettings);
        document.getElementById("settingSnippetLines").addEventListener("input", function () {
            settings.snippetLines = parseInt(this.value) || 2;
            document.getElementById("snippetLinesValue").textContent = settings.snippetLines;
        });
        document.getElementById("settingSnippetLines").addEventListener("change", saveSettings);
        ["Archive", "Star", "Trash", "MarkRead", "MarkImportant", "Snooze"].forEach(function (action) {
            var el = document.getElementById("action" + action);
            var key = action.charAt(0).toLowerCase() + action.slice(1);
            el.addEventListener("change", function () { settings.actions[key] = this.checked; saveSettings(); });
        });
    }

    function init() {
        loadSettings();
        initSettingsListeners();
        renderCards();
        cards.forEach(function (card) { if (!card.collapsed) loadThreads(card.id); });
        setInterval(function () { cards.forEach(function (card) { if (!card.collapsed) refreshCard(card.id); }); }, AUTO_REFRESH_INTERVAL);
    }

    function renderCards() {
        var container = document.getElementById("cardRow");
        container.innerHTML = "";
        cards.sort(function (a, b) { return a.order - b.order; });
        cards.forEach(function (card) { container.appendChild(createCardElement(card)); });
        var addBtn = document.createElement("div");
        addBtn.className = "add-card";
        addBtn.onclick = showAddModal;
        addBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
        container.appendChild(addBtn);
    }

    function createCardElement(card) {
        var div = document.createElement("div");
        div.className = "card" + (card.collapsed ? " collapsed" : "");
        div.dataset.id = card.id;
        div.draggable = true;

        var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var lightColor = card.bgColorLight || card.bgColor || '';
        var darkColor = card.bgColorDark || '';
        var borderColor = card.borderColor || '';
        if (lightColor || darkColor) {
            div.style.background = isDark ? (darkColor || lightColor) : lightColor;
            div.dataset.bgLight = lightColor;
            div.dataset.bgDark = darkColor;
        }
        if (borderColor) {
            div.style.borderColor = borderColor;
            div.style.setProperty('--card-border-color', borderColor);
            div.dataset.borderColor = borderColor;
        }

        div.addEventListener("dragstart", function (e) { div.classList.add("dragging"); e.dataTransfer.effectAllowed = "move"; e.dataTransfer.setData("text/plain", card.id); });
        div.addEventListener("dragend", function () { div.classList.remove("dragging"); document.querySelectorAll(".card.drag-over").forEach(function (c) { c.classList.remove("drag-over"); }); });
        div.addEventListener("dragover", function (e) { e.preventDefault(); var dragging = document.querySelector(".card.dragging"); if (dragging && dragging !== div) div.classList.add("drag-over"); });
        div.addEventListener("dragleave", function () { div.classList.remove("drag-over"); });
        div.addEventListener("drop", function (e) { e.preventDefault(); div.classList.remove("drag-over"); var draggedId = e.dataTransfer.getData("text/plain"); if (draggedId && draggedId !== card.id) reorderCard(draggedId, card.id); });

        div.innerHTML = '<div class="card-header">' +
            '<button class="collapse-btn" onclick="toggleCard(\'' + card.id + '\')"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg></button>' +
            '<div class="card-title" ondblclick="startEditTitle(\'' + card.id + '\')">' + escapeHtml(card.friendlyName) + '</div>' +
            '<input class="card-title-input" type="text" value="' + escapeHtml(card.friendlyName) + '" onblur="finishEditTitle(\'' + card.id + '\', this)" onkeydown="handleTitleKey(event, \'' + card.id + '\', this)">' +
            '<div class="card-actions">' +
            '<button class="icon-btn refresh-btn" onclick="refreshCard(\'' + card.id + '\')" title="Refresh"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>' +
            '<button class="icon-btn" onclick="showEditModal(\'' + card.id + '\')" title="Edit query"><svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></button>' +
            '</div></div>' +
            '<div class="card-body" id="body-' + card.id + '">' + (card.collapsed ? "" : '<div class="loading">Loading...</div>') + '</div>' +
            '<div class="card-form" id="form-' + card.id + '">' +
            '<div class="card-form-group"><label>Name</label><input type="text" class="form-name" value="' + escapeHtml(card.friendlyName) + '" placeholder="e.g. Important"></div>' +
            '<div class="card-form-group"><label>Gmail Search Query</label><input type="text" class="form-query" value="' + escapeHtml(card.query) + '" placeholder="e.g. label:inbox is:unread">' +
            '<div class="card-form-filters">' +
            '<button type="button" class="filter-chip" data-filter="from:">from:</button>' +
            '<button type="button" class="filter-chip" data-filter="to:">to:</button>' +
            '<button type="button" class="filter-chip" data-filter="subject:">subject:</button>' +
            '<button type="button" class="filter-chip" data-filter="label:">label:</button>' +
            '<button type="button" class="filter-chip" data-filter="filename:">filename:</button>' +
            '<div class="filter-dropdown"><button type="button" class="filter-dropdown-btn">is: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button><div class="filter-dropdown-menu"><button type="button" class="filter-dropdown-item" data-filter="is:unread">is:unread</button><button type="button" class="filter-dropdown-item" data-filter="is:read">is:read</button><button type="button" class="filter-dropdown-item" data-filter="is:starred">is:starred</button><button type="button" class="filter-dropdown-item" data-filter="is:important">is:important</button><button type="button" class="filter-dropdown-item" data-filter="is:muted">is:muted</button></div></div>' +
            '<div class="filter-dropdown"><button type="button" class="filter-dropdown-btn">has: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button><div class="filter-dropdown-menu"><button type="button" class="filter-dropdown-item" data-filter="has:attachment">has:attachment</button><button type="button" class="filter-dropdown-item" data-filter="has:drive">has:drive</button><button type="button" class="filter-dropdown-item" data-filter="has:document">has:document</button><button type="button" class="filter-dropdown-item" data-filter="has:spreadsheet">has:spreadsheet</button><button type="button" class="filter-dropdown-item" data-filter="has:presentation">has:presentation</button><button type="button" class="filter-dropdown-item" data-filter="has:youtube">has:youtube</button></div></div>' +
            '<div class="filter-dropdown"><button type="button" class="filter-dropdown-btn">in: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button><div class="filter-dropdown-menu"><button type="button" class="filter-dropdown-item" data-filter="in:inbox">in:inbox</button><button type="button" class="filter-dropdown-item" data-filter="in:sent">in:sent</button><button type="button" class="filter-dropdown-item" data-filter="in:drafts">in:drafts</button><button type="button" class="filter-dropdown-item" data-filter="in:archive">in:archive</button><button type="button" class="filter-dropdown-item" data-filter="in:snoozed">in:snoozed</button><button type="button" class="filter-dropdown-item" data-filter="in:spam">in:spam</button><button type="button" class="filter-dropdown-item" data-filter="in:trash">in:trash</button><button type="button" class="filter-dropdown-item" data-filter="in:anywhere">in:anywhere</button></div></div>' +
            '<div class="filter-dropdown"><button type="button" class="filter-dropdown-btn">category: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button><div class="filter-dropdown-menu"><button type="button" class="filter-dropdown-item" data-filter="category:primary">category:primary</button><button type="button" class="filter-dropdown-item" data-filter="category:social">category:social</button><button type="button" class="filter-dropdown-item" data-filter="category:promotions">category:promotions</button><button type="button" class="filter-dropdown-item" data-filter="category:updates">category:updates</button><button type="button" class="filter-dropdown-item" data-filter="category:forums">category:forums</button></div></div>' +
            '<div class="filter-dropdown"><button type="button" class="filter-dropdown-btn">Date <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button><div class="filter-dropdown-menu"><button type="button" class="filter-dropdown-item" data-filter="newer_than:">newer_than:</button><button type="button" class="filter-dropdown-item" data-filter="older_than:">older_than:</button><button type="button" class="filter-dropdown-item" data-filter="after:">after:</button><button type="button" class="filter-dropdown-item" data-filter="before:">before:</button></div></div>' +
            '<div class="filter-dropdown"><button type="button" class="filter-dropdown-btn">Size <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></button><div class="filter-dropdown-menu"><button type="button" class="filter-dropdown-item" data-filter="larger:">larger:</button><button type="button" class="filter-dropdown-item" data-filter="smaller:">smaller:</button><button type="button" class="filter-dropdown-item" data-filter="size:">size:</button></div></div>' +
            '</div></div>' +
            '<div class="card-form-group"><label>Group by</label><div class="card-form-groupby">' +
            '<label class="groupby-option"><input type="radio" name="groupby-' + card.id + '" value="date"' + (card.groupBy !== "sender" ? " checked" : "") + '> Date</label>' +
            '<label class="groupby-option"><input type="radio" name="groupby-' + card.id + '" value="sender"' + (card.groupBy === "sender" ? " checked" : "") + '> Sender</label>' +
            '</div></div>' +
            '<div class="card-form-group"><div class="color-picker-row"><label>Card Color</label>' + buildColorPicker(card.id, card.borderColor || '') + '</div></div>' +
            '<div class="card-form-actions">' + (card.isNew ? "" : '<button type="button" class="btn btn-danger" onclick="confirmDeleteCard(\'' + card.id + '\')">Delete</button>') +
            '<div style="flex-grow:1"></div><button type="button" class="btn btn-secondary" onclick="cancelCardForm(\'' + card.id + '\')">Cancel</button>' +
            '<button type="button" class="btn" onclick="saveCardForm(\'' + card.id + '\')">Save</button></div>' +
            '<div class="card-form-preview" id="preview-' + card.id + '"></div></div>';

        setTimeout(function () {
            var form = document.getElementById("form-" + card.id);
            if (!form) return;
            function insertFilter(filter) {
                var input = form.querySelector(".form-query");
                var val = input.value;
                if (val && !val.endsWith(" ")) val += " ";
                input.value = val + filter;
                input.focus();
                input.setSelectionRange(input.value.length, input.value.length);
                previewQuery(card.id);
            }
            form.querySelectorAll(".filter-chip").forEach(function (chip) { chip.addEventListener("click", function () { insertFilter(this.dataset.filter); }); });
            form.querySelectorAll(".filter-dropdown-btn").forEach(function (btn) {
                btn.addEventListener("click", function (e) {
                    e.stopPropagation();
                    var dropdown = this.parentElement;
                    var wasOpen = dropdown.classList.contains("open");
                    form.querySelectorAll(".filter-dropdown.open").forEach(function (d) { d.classList.remove("open"); });
                    if (!wasOpen) dropdown.classList.add("open");
                });
            });
            form.querySelectorAll(".filter-dropdown-item").forEach(function (item) {
                item.addEventListener("click", function (e) { e.stopPropagation(); insertFilter(this.dataset.filter); this.closest(".filter-dropdown").classList.remove("open"); });
            });
            document.addEventListener("click", function () { form.querySelectorAll(".filter-dropdown.open").forEach(function (d) { d.classList.remove("open"); }); });
            var queryInput = form.querySelector(".form-query");
            var debounceTimer;
            queryInput.addEventListener("input", function () { clearTimeout(debounceTimer); debounceTimer = setTimeout(function () { previewQuery(card.id); }, 500); });
            form.querySelectorAll('input[name="groupby-' + card.id + '"]').forEach(function (radio) { radio.addEventListener("change", function () { previewQuery(card.id); }); });
        }, 0);

        return div;
    }

    function toggleCard(cardId) {
        var card = cards.find(function (c) { return c.id === cardId; });
        if (!card) return;
        card.collapsed = !card.collapsed;
        var el = document.querySelector('.card[data-id="' + cardId + '"]');
        if (el) el.classList.toggle("collapsed", card.collapsed);
        if (!card.collapsed && !cardData[cardId]) {
            document.getElementById("body-" + cardId).innerHTML = '<div class="loading">Loading...</div>';
            loadThreads(cardId);
        }
        google.script.run.updateCard(cardId, { collapsed: card.collapsed });
    }

    function loadThreads(cardId, startIndex, silent) {
        startIndex = startIndex || 0;
        var refreshBtn = document.querySelector('.card[data-id="' + cardId + '"] .refresh-btn');
        if (refreshBtn) refreshBtn.classList.add("spinning");
        if (startIndex === 0 && !silent && !cardData[cardId]) document.getElementById("body-" + cardId).innerHTML = '<div class="loading">Loading...</div>';

        google.script.run.withSuccessHandler(function (resp) {
            if (refreshBtn) refreshBtn.classList.remove("spinning");
            if (startIndex === 0) { cardData[cardId] = resp; }
            else {
                resp.groups.forEach(function (newGroup) {
                    var existing = cardData[cardId].groups.find(function (g) { return g.label === newGroup.label; });
                    if (existing) existing.threads = existing.threads.concat(newGroup.threads);
                    else cardData[cardId].groups.push(newGroup);
                });
                cardData[cardId].nextStart = resp.nextStart;
                cardData[cardId].hasMore = resp.hasMore;
            }
            cardData[cardId].loading = false;
            renderThreads(cardId);
        }).withFailureHandler(function (err) {
            if (refreshBtn) refreshBtn.classList.remove("spinning");
            if (cardData[cardId]) cardData[cardId].loading = false;
            if (!cardData[cardId]) document.getElementById("body-" + cardId).innerHTML = '<div class="empty">Error: ' + escapeHtml(err.message) + '</div>';
        }).fetchThreadsForCard(cardId, startIndex);
    }

    function renderThreads(cardId) {
        var body = document.getElementById("body-" + cardId);
        var data = cardData[cardId];
        if (!data || !data.groups || data.groups.length === 0) { body.innerHTML = '<div class="empty">No messages found</div>'; return; }

        // Preserve quick reply state before re-rendering
        var quickReplyState = null;
        if (currentQuickReply && currentQuickReply.cardId === cardId) {
            var textarea = document.getElementById('quickReplyText');
            quickReplyState = {
                threadId: currentQuickReply.threadId,
                text: textarea ? textarea.value : ''
            };
        }

        // Initialize selection set for this card if needed
        if (!selectedThreads[cardId]) selectedThreads[cardId] = new Set();
        var selected = selectedThreads[cardId];

        var html = "";
        data.groups.forEach(function (group) {
            html += '<div class="date-group"><div class="date-header">' + escapeHtml(group.label) + '</div>';
            group.threads.forEach(function (t) {
                var isSelected = selected.has(t.threadId);
                html += '<div class="thread' + (t.unread ? " unread" : "") + (isSelected ? " selected" : "") + '" data-thread="' + t.threadId + '" data-card="' + cardId + '" onmouseenter="showThreadHoverActions(this.querySelector(\'.thread-checkbox-wrap\'))" onmouseleave="hideThreadHoverActions(this.querySelector(\'.thread-checkbox-wrap\'))">';
                html += '<div class="thread-row">';
                html += (t.unread ? '<div class="unread-badge"></div>' : '') + '<div class="thread-subject" onclick="openThread(\'' + t.threadId + '\')">' + escapeHtml(t.subject) + '</div>';
                // Time and checkbox wrapper - checkbox replaces time on hover
                html += '<div class="thread-time-wrap">';
                html += '<div class="thread-time">' + formatTime(t.lastMsgDate) + '</div>';
                html += '<div class="thread-checkbox-wrap" data-card="' + cardId + '" data-thread="' + t.threadId + '">';
                html += '<input type="checkbox" class="thread-checkbox" ' + (isSelected ? 'checked' : '') + ' onclick="event.stopPropagation(); handleCheckboxClick(event, \'' + cardId + '\', \'' + t.threadId + '\')">';
                html += '</div>';
                html += '</div></div>';
                html += '<div class="thread-snippet" onclick="openThread(\'' + t.threadId + '\')">' + escapeHtml(t.snippet) + '</div>';
                if (t.participants) html += '<div class="thread-participants">' + escapeHtml(t.participants) + '</div>';

                // Lazy load attachments - show indicator if has attachments
                if (t.hasAttachments && t.attachmentCount > 0) {
                    html += '<div class="thread-attachments" data-thread="' + t.threadId + '">';
                    if (t.attachmentsLoaded && t.attachments) {
                        // Show loaded attachments
                        t.attachments.forEach(function(att) {
                            if (att.isImage && att.preview) {
                                html += '<div class="attachment attachment-image"><div class="attachment-info"><svg class="attachment-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><span class="attachment-name">' + escapeHtml(att.name) + '</span><span class="attachment-size">' + formatFileSize(att.size) + '</span></div><div class="attachment-preview"><img src="' + att.preview + '" alt="' + escapeHtml(att.name) + '"></div></div>';
                            } else {
                                html += '<div class="attachment">' + getAttachmentIcon(att.contentType) + '<span class="attachment-name">' + escapeHtml(att.name) + '</span><span class="attachment-size">' + formatFileSize(att.size) + '</span></div>';
                            }
                        });
                    } else {
                        // Show lazy load button
                        html += '<button class="attachment-load-btn" onclick="event.stopPropagation(); loadAttachments(\'' + cardId + '\', \'' + t.threadId + '\')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg> ' + t.attachmentCount + ' attachment' + (t.attachmentCount > 1 ? 's' : '') + '</button>';
                    }
                    html += '</div>';
                }

                html += '</div>';
            });
            html += '</div>';
        });
        body.innerHTML = html;

        if (data.hasMore) {
            body.onscroll = function () { if (body.scrollTop + body.clientHeight >= body.scrollHeight - 50) { if (!cardData[cardId].loading) loadMore(cardId); } };
        } else { body.onscroll = null; }

        // Update bulk actions bar
        updateBulkActionsBar(cardId);

        // Restore quick reply if it was open
        if (quickReplyState) {
            var threadEl = document.querySelector('.thread[data-thread="' + quickReplyState.threadId + '"]');
            if (threadEl) {
                currentQuickReply = null; // Clear so showQuickReply doesn't try to close
                showQuickReply(cardId, quickReplyState.threadId, quickReplyState.text);
            }
        }
    }

    // Lazy load attachments for a thread
    function loadAttachments(cardId, threadId) {
        var btn = document.querySelector('.thread[data-thread="' + threadId + '"] .attachment-load-btn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Loading...';
        }

        google.script.run
            .withSuccessHandler(function(attachments) {
                // Update the thread data
                if (cardData[cardId] && cardData[cardId].groups) {
                    cardData[cardId].groups.forEach(function(g) {
                        g.threads.forEach(function(t) {
                            if (t.threadId === threadId) {
                                t.attachments = attachments;
                                t.attachmentsLoaded = true;
                            }
                        });
                    });
                }
                renderThreads(cardId);
            })
            .withFailureHandler(function(err) {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Failed to load. Retry?';
                }
            })
            .loadThreadAttachments(threadId);
    }

    // Selection management
    var lastSelectedThread = {}; // { cardId: threadId } - for shift-click range selection

    function handleCheckboxClick(event, cardId, threadId) {
        var checkbox = event.target;
        var willBeChecked = checkbox.checked; // The new state after click

        if (!selectedThreads[cardId]) selectedThreads[cardId] = new Set();

        // Shift-click for range selection
        if (event.shiftKey && lastSelectedThread[cardId] && willBeChecked) {
            event.preventDefault();
            selectRange(cardId, lastSelectedThread[cardId], threadId);
            return;
        }

        // Normal click
        if (willBeChecked) {
            selectedThreads[cardId].add(threadId);
            lastSelectedThread[cardId] = threadId;
        } else {
            selectedThreads[cardId].delete(threadId);
        }

        var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
        if (threadEl) threadEl.classList.toggle('selected', willBeChecked);

        updateBulkActionsBar(cardId);
    }

    function toggleThreadSelection(cardId, threadId, isSelected) {
        if (!selectedThreads[cardId]) selectedThreads[cardId] = new Set();

        if (isSelected) {
            selectedThreads[cardId].add(threadId);
            lastSelectedThread[cardId] = threadId;
        } else {
            selectedThreads[cardId].delete(threadId);
        }

        var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
        if (threadEl) threadEl.classList.toggle('selected', isSelected);

        updateBulkActionsBar(cardId);
    }

    function selectRange(cardId, startThreadId, endThreadId) {
        if (!cardData[cardId] || !cardData[cardId].groups) return;

        // Get flat list of all thread IDs in order
        var allThreadIds = [];
        cardData[cardId].groups.forEach(function(g) {
            g.threads.forEach(function(t) {
                allThreadIds.push(t.threadId);
            });
        });

        var startIdx = allThreadIds.indexOf(startThreadId);
        var endIdx = allThreadIds.indexOf(endThreadId);

        if (startIdx === -1 || endIdx === -1) return;

        // Ensure start < end
        if (startIdx > endIdx) {
            var tmp = startIdx;
            startIdx = endIdx;
            endIdx = tmp;
        }

        // Select all threads in range
        for (var i = startIdx; i <= endIdx; i++) {
            selectedThreads[cardId].add(allThreadIds[i]);
        }

        lastSelectedThread[cardId] = endThreadId;
        renderThreads(cardId);
    }

    function selectAllInCard(cardId) {
        if (!cardData[cardId] || !cardData[cardId].groups) return;
        if (!selectedThreads[cardId]) selectedThreads[cardId] = new Set();

        cardData[cardId].groups.forEach(function(g) {
            g.threads.forEach(function(t) {
                selectedThreads[cardId].add(t.threadId);
            });
        });
        renderThreads(cardId);
    }

    function clearSelectionInCard(cardId) {
        if (selectedThreads[cardId]) {
            selectedThreads[cardId].clear();
        }
        renderThreads(cardId);
    }

    function getSelectedCount(cardId) {
        return selectedThreads[cardId] ? selectedThreads[cardId].size : 0;
    }

    function getTotalSelectedCount() {
        var count = 0;
        for (var cardId in selectedThreads) {
            count += selectedThreads[cardId].size;
        }
        return count;
    }

    function updateBulkActionsBar(cardId) {
        var count = getSelectedCount(cardId);

        // Remove all existing bulk wheels
        document.querySelectorAll('.card[data-id="' + cardId + '"] .bulk-actions-wheel').forEach(function(w) { w.remove(); });

        if (count === 0) return;

        // Find the first selected thread and add wheel around its checkbox
        var firstSelected = document.querySelector('.card[data-id="' + cardId + '"] .thread.selected');
        if (!firstSelected) return;

        var checkboxWrap = firstSelected.querySelector('.thread-checkbox-wrap');
        if (!checkboxWrap) return;

        // Create wheel with bulk actions + clear button
        createActionsWheel(checkboxWrap, cardId, null, count);
    }

    // Hover actions for single thread
    var hoverActionsTimeout = null;
    var activeHoverWrap = null;

    function showThreadHoverActions(wrap) {
        if (hoverActionsTimeout) {
            clearTimeout(hoverActionsTimeout);
            hoverActionsTimeout = null;
        }

        var cardId = wrap.dataset.card;
        var threadId = wrap.dataset.thread;
        var count = getSelectedCount(cardId);

        // If threads are selected, don't show hover actions on non-selected threads
        if (count > 0 && !wrap.closest('.thread').classList.contains('selected')) {
            return;
        }

        // Don't recreate if already showing on this wrap
        if (activeHoverWrap === wrap && wrap.querySelector('.bulk-actions-wheel')) {
            return;
        }

        // Remove any existing wheel on other wraps
        if (activeHoverWrap && activeHoverWrap !== wrap) {
            var oldWheel = activeHoverWrap.querySelector('.bulk-actions-wheel');
            if (oldWheel) oldWheel.remove();
        }

        activeHoverWrap = wrap;

        // If there are selected threads, show bulk actions, otherwise single thread actions
        if (count > 0) {
            createActionsWheel(wrap, cardId, null, count);
        } else {
            createActionsWheel(wrap, cardId, threadId, 0);
        }
    }

    function hideThreadHoverActions(wrap) {
        var cardId = wrap.dataset.card;
        var count = getSelectedCount(cardId);

        // Don't hide if threads are selected (keep showing bulk actions)
        if (count > 0 && wrap.closest('.thread').classList.contains('selected')) {
            return;
        }

        hoverActionsTimeout = setTimeout(function() {
            var wheel = wrap.querySelector('.bulk-actions-wheel');
            if (wheel) {
                wheel.classList.remove('open');
                setTimeout(function() { wheel.remove(); }, 200);
            }
            if (activeHoverWrap === wrap) {
                activeHoverWrap = null;
            }
        }, 100);
    }

    function createActionsWheel(wrap, cardId, threadId, selectedCount) {
        // Remove existing wheel
        var existing = wrap.querySelector('.bulk-actions-wheel');
        if (existing) existing.remove();

        var wheel = document.createElement('div');
        wheel.className = 'bulk-actions-wheel';
        wheel.setAttribute('onmouseenter', 'keepActionsWheelOpen()');

        var actions = [];

        if (selectedCount > 0) {
            // Bulk actions based on settings + clear
            wheel.innerHTML = '<span class="bulk-count">' + selectedCount + '</span>';
            if (settings.actions.archive) actions.push({ cls: 'bulk-archive', title: 'Archive', onclick: "bulkArchive('" + cardId + "')", icon: '<path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/>' });
            if (settings.actions.star) actions.push({ cls: 'bulk-star', title: 'Star', onclick: "bulkStar('" + cardId + "')", icon: '<path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>' });
            if (settings.actions.markRead) actions.push({ cls: 'bulk-read', title: 'Mark as read', onclick: "bulkMarkRead('" + cardId + "')", icon: '<path d="M21.99 8c0-.72-.37-1.35-.94-1.7L12 1 2.95 6.3C2.38 6.65 2 7.28 2 8v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2l-.01-10zM12 13L3.74 7.84 12 3l8.26 4.84L12 13z"/>' });
            if (settings.actions.trash) actions.push({ cls: 'bulk-danger', title: 'Delete', onclick: "bulkTrash('" + cardId + "')", icon: '<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>' });
            // Always add clear at the end
            actions.push({ cls: 'bulk-clear', title: 'Clear selection', onclick: "clearSelectionInCard('" + cardId + "')", icon: '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>' });
        } else {
            // Single thread actions based on settings
            // Quick reply is always available
            actions.push({ cls: 'bulk-reply', title: 'Quick reply', onclick: "showQuickReply('" + cardId + "', '" + threadId + "')", icon: '<path d="M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11z"/>' });
            if (settings.actions.archive) actions.push({ cls: 'bulk-archive', title: 'Archive', onclick: "archiveThread('" + cardId + "', '" + threadId + "')", icon: '<path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/>' });
            if (settings.actions.star) actions.push({ cls: 'bulk-star', title: 'Star', onclick: "starThread('" + cardId + "', '" + threadId + "')", icon: '<path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>' });
            if (settings.actions.markRead) {
                // Get thread unread state
                var threadEl = wrap.closest('.thread');
                var isUnread = threadEl && threadEl.classList.contains('unread');
                var readTitle = isUnread ? 'Mark as read' : 'Mark as unread';
                actions.push({ cls: 'bulk-read', title: readTitle, onclick: "toggleReadThread('" + cardId + "', '" + threadId + "', " + isUnread + ")", icon: isUnread ? '<path d="M21.99 8c0-.72-.37-1.35-.94-1.7L12 1 2.95 6.3C2.38 6.65 2 7.28 2 8v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2l-.01-10zM12 13L3.74 7.84 12 3l8.26 4.84L12 13z"/>' : '<path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>' });
            }
            if (settings.actions.markImportant) actions.push({ cls: 'bulk-important', title: 'Mark as important', onclick: "toggleImportantThread('" + cardId + "', '" + threadId + "')", icon: '<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>' });
            if (settings.actions.snooze) actions.push({ cls: 'bulk-snooze', title: 'Snooze', onclick: "snoozeThread('" + cardId + "', '" + threadId + "')", icon: '<path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>' });
            if (settings.actions.trash) actions.push({ cls: 'bulk-danger', title: 'Delete', onclick: "trashThread('" + cardId + "', '" + threadId + "')", icon: '<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>' });
        }

        // Don't show wheel if no actions
        if (actions.length === 0) return;

        // Calculate radial positions (left side semicircle since checkbox is on right)
        var radius = 32;
        var numActions = actions.length;
        actions.forEach(function(action, i) {
            var angle, x, y;
            if (numActions === 1) {
                // Single action - position to the left
                x = -radius;
                y = 0;
            } else {
                // Spread from top-left to bottom-left
                angle = (2 * Math.PI / 3) + (i / (numActions - 1)) * (2 * Math.PI / 3);
                x = radius * Math.cos(angle);
                y = radius * Math.sin(angle);
            }
            wheel.innerHTML += '<button class="bulk-btn ' + action.cls + '" data-x="' + x.toFixed(1) + '" data-y="' + y.toFixed(1) + '" onclick="event.stopPropagation(); ' + action.onclick + '" title="' + action.title + '"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">' + action.icon + '</svg></button>';
        });

        wrap.appendChild(wheel);

        // Animate open
        setTimeout(function() {
            wheel.classList.add('open');
            var buttons = wheel.querySelectorAll('.bulk-btn');
            buttons.forEach(function(btn) {
                var x = parseFloat(btn.dataset.x) || 0;
                var y = parseFloat(btn.dataset.y) || 0;
                btn.style.left = 'calc(50% + ' + x + 'px - 14px)';
                btn.style.top = 'calc(50% + ' + y + 'px - 14px)';
            });
        }, 10);
    }

    function keepActionsWheelOpen() {
        if (hoverActionsTimeout) {
            clearTimeout(hoverActionsTimeout);
            hoverActionsTimeout = null;
        }
    }

    function loadMore(cardId) { var data = cardData[cardId]; if (data && data.nextStart && !data.loading) { data.loading = true; loadThreads(cardId, data.nextStart); } }
    function refreshCard(cardId) { loadThreads(cardId, 0, true); }

    function startEditTitle(cardId) {
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (!cardEl || cardEl.classList.contains("collapsed")) return;
        cardEl.classList.add("editing");
        var input = cardEl.querySelector(".card-title-input");
        input.focus(); input.select();
    }

    function finishEditTitle(cardId, input) {
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (!cardEl) return;
        cardEl.classList.remove("editing");
        var newName = input.value.trim();
        if (!newName) return;
        var card = cards.find(function (c) { return c.id === cardId; });
        if (card && card.friendlyName !== newName) {
            card.friendlyName = newName;
            cardEl.querySelector(".card-title").textContent = newName;
            google.script.run.updateCard(cardId, { friendlyName: newName });
        }
    }

    function handleTitleKey(e, cardId, input) {
        if (e.key === "Enter") { e.preventDefault(); input.blur(); }
        else if (e.key === "Escape") { var card = cards.find(function (c) { return c.id === cardId; }); if (card) input.value = card.friendlyName; input.blur(); }
    }

    function reorderCard(draggedId, targetId) {
        var draggedIdx = cards.findIndex(function (c) { return c.id === draggedId; });
        var targetIdx = cards.findIndex(function (c) { return c.id === targetId; });
        if (draggedIdx === -1 || targetIdx === -1) return;
        var dragged = cards.splice(draggedIdx, 1)[0];
        targetIdx = cards.findIndex(function (c) { return c.id === targetId; });
        cards.splice(targetIdx, 0, dragged);
        cards.forEach(function (c, i) { c.order = i; });
        renderCards();
        cards.forEach(function (card) { if (!card.collapsed && cardData[card.id]) renderThreads(card.id); });
        google.script.run.reorderCards(cards.map(function (c) { return c.id; }));
    }

    function openThread(threadId) {
        window.open("https://mail.google.com/mail/u/0/#all/" + threadId, "_blank");
    }

    function archiveThread(cardId, threadId) {
        var threadData = getThreadData(cardId, threadId);
        removeThreadFromUI(cardId, threadId);

        var undoId = showUndoToast('Thread archived', function() {
            google.script.run.unarchiveThread(threadId);
            restoreThreadToUI(cardId, threadData);
        });

        google.script.run
            .withSuccessHandler(function() { finalizeUndo(undoId); })
            .withFailureHandler(function() { cancelUndo(undoId); restoreThreadToUI(cardId, threadData); })
            .archiveThread(threadId);
    }

    function starThread(cardId, threadId) { google.script.run.starThread(threadId, true); }

    function trashThread(cardId, threadId) {
        var threadData = getThreadData(cardId, threadId);
        removeThreadFromUI(cardId, threadId);

        var undoId = showUndoToast('Thread deleted', function() {
            google.script.run.untrashThread(threadId);
            restoreThreadToUI(cardId, threadData);
        });

        google.script.run
            .withSuccessHandler(function() { finalizeUndo(undoId); })
            .withFailureHandler(function() { cancelUndo(undoId); restoreThreadToUI(cardId, threadData); })
            .trashThread(threadId);
    }

    function toggleReadThread(cardId, threadId, markAsRead) {
        var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
        if (threadEl) {
            threadEl.classList.toggle("unread", !markAsRead);
            var badge = threadEl.querySelector(".unread-badge");
            if (markAsRead && badge) badge.remove();
            if (!markAsRead && !badge) { var row = threadEl.querySelector(".thread-row"); var newBadge = document.createElement("div"); newBadge.className = "unread-badge"; row.insertBefore(newBadge, row.firstChild.nextSibling); }
        }
        if (cardData[cardId]) { cardData[cardId].groups.forEach(function (g) { g.threads.forEach(function (t) { if (t.threadId === threadId) t.unread = markAsRead ? 0 : 1; }); }); }
        google.script.run.markThreadRead(threadId, markAsRead);
    }

    function toggleImportantThread(cardId, threadId) { google.script.run.toggleImportant(threadId); }
    function snoozeThread(cardId, threadId) { alert("Snooze is not directly supported. Opening thread in Gmail where you can snooze it."); openThread(threadId); }

    // Get thread data for undo
    function getThreadData(cardId, threadId) {
        if (!cardData[cardId] || !cardData[cardId].groups) return null;
        for (var i = 0; i < cardData[cardId].groups.length; i++) {
            var group = cardData[cardId].groups[i];
            for (var j = 0; j < group.threads.length; j++) {
                if (group.threads[j].threadId === threadId) {
                    return { thread: JSON.parse(JSON.stringify(group.threads[j])), groupLabel: group.label, groupIndex: i, threadIndex: j, cardId: cardId };
                }
            }
        }
        return null;
    }

    // Restore thread to UI after undo
    function restoreThreadToUI(cardId, threadData) {
        if (!threadData || !cardData[cardId]) return;

        // Find the group or create it
        var group = cardData[cardId].groups.find(function(g) { return g.label === threadData.groupLabel; });
        if (!group) {
            group = { label: threadData.groupLabel, threads: [] };
            cardData[cardId].groups.splice(threadData.groupIndex, 0, group);
        }

        // Insert thread at original position
        group.threads.splice(threadData.threadIndex, 0, threadData.thread);
        renderThreads(cardId);
    }

    function removeThreadFromUI(cardId, threadId) {
        var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
        if (threadEl) {
            threadEl.style.opacity = "0"; threadEl.style.height = threadEl.offsetHeight + "px";
            setTimeout(function () { threadEl.style.height = "0"; threadEl.style.padding = "0"; threadEl.style.margin = "0"; threadEl.style.overflow = "hidden"; }, 150);
            setTimeout(function () { threadEl.remove(); }, 300);
        }
        if (cardData[cardId]) { cardData[cardId].groups.forEach(function (g) { g.threads = g.threads.filter(function (t) { return t.threadId !== threadId; }); }); }
        // Clear from selection if selected
        if (selectedThreads[cardId]) selectedThreads[cardId].delete(threadId);
    }

    function removeMultipleThreadsFromUI(cardId, threadIds) {
        threadIds.forEach(function(threadId) {
            var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
            if (threadEl) threadEl.remove();
            if (selectedThreads[cardId]) selectedThreads[cardId].delete(threadId);
        });
        if (cardData[cardId]) {
            cardData[cardId].groups.forEach(function (g) {
                g.threads = g.threads.filter(function (t) { return threadIds.indexOf(t.threadId) === -1; });
            });
        }
        updateBulkActionsBar(cardId);
    }

    // Undo toast system
    function showUndoToast(message, undoCallback) {
        var id = 'undo-' + Date.now();
        var toast = document.createElement('div');
        toast.className = 'undo-toast';
        toast.id = id;
        toast.innerHTML = '<span class="undo-message">' + escapeHtml(message) + '</span>' +
            '<button class="undo-btn" onclick="executeUndo(\'' + id + '\')">Undo</button>' +
            '<button class="undo-close" onclick="dismissUndo(\'' + id + '\')"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>' +
            '<div class="undo-progress"><div class="undo-progress-bar"></div></div>';

        document.body.appendChild(toast);

        // Position toasts
        updateToastPositions();

        var undoItem = {
            id: id,
            callback: undoCallback,
            toast: toast,
            executed: false,
            timer: setTimeout(function() { dismissUndo(id); }, UNDO_TIMEOUT)
        };

        undoQueue.push(undoItem);

        // Animate in
        setTimeout(function() { toast.classList.add('visible'); }, 10);

        return id;
    }

    function updateToastPositions() {
        var toasts = document.querySelectorAll('.undo-toast');
        var bottom = 60;
        toasts.forEach(function(toast) {
            toast.style.bottom = bottom + 'px';
            bottom += toast.offsetHeight + 8;
        });
    }

    function executeUndo(id) {
        var item = undoQueue.find(function(u) { return u.id === id; });
        if (!item || item.executed) return;

        item.executed = true;
        clearTimeout(item.timer);

        if (item.callback) item.callback();

        dismissUndo(id);
    }

    function dismissUndo(id) {
        var item = undoQueue.find(function(u) { return u.id === id; });
        if (!item) return;

        clearTimeout(item.timer);
        item.toast.classList.remove('visible');

        setTimeout(function() {
            if (item.toast.parentNode) item.toast.remove();
            undoQueue = undoQueue.filter(function(u) { return u.id !== id; });
            updateToastPositions();
        }, 200);
    }

    function finalizeUndo(id) {
        // Action completed successfully on server - nothing special to do
    }

    function cancelUndo(id) {
        var item = undoQueue.find(function(u) { return u.id === id; });
        if (item) {
            item.executed = true; // Prevent undo from doing anything
            dismissUndo(id);
        }
    }

    // Bulk actions
    function bulkArchive(cardId) {
        var threadIds = Array.from(selectedThreads[cardId] || []);
        if (threadIds.length === 0) return;

        var threadDataList = threadIds.map(function(id) { return getThreadData(cardId, id); }).filter(Boolean);

        removeMultipleThreadsFromUI(cardId, threadIds);

        var undoId = showUndoToast(threadIds.length + ' threads archived', function() {
            google.script.run.bulkUnarchiveThreads(threadIds);
            threadDataList.forEach(function(td) { restoreThreadToUI(cardId, td); });
        });

        google.script.run
            .withSuccessHandler(function() { finalizeUndo(undoId); })
            .withFailureHandler(function() { cancelUndo(undoId); threadDataList.forEach(function(td) { restoreThreadToUI(cardId, td); }); })
            .bulkArchiveThreads(threadIds);
    }

    function bulkTrash(cardId) {
        var threadIds = Array.from(selectedThreads[cardId] || []);
        if (threadIds.length === 0) return;

        var threadDataList = threadIds.map(function(id) { return getThreadData(cardId, id); }).filter(Boolean);

        removeMultipleThreadsFromUI(cardId, threadIds);

        var undoId = showUndoToast(threadIds.length + ' threads deleted', function() {
            google.script.run.bulkUntrashThreads(threadIds);
            threadDataList.forEach(function(td) { restoreThreadToUI(cardId, td); });
        });

        google.script.run
            .withSuccessHandler(function() { finalizeUndo(undoId); })
            .withFailureHandler(function() { cancelUndo(undoId); threadDataList.forEach(function(td) { restoreThreadToUI(cardId, td); }); })
            .bulkTrashThreads(threadIds);
    }

    function bulkStar(cardId) {
        var threadIds = Array.from(selectedThreads[cardId] || []);
        if (threadIds.length === 0) return;

        google.script.run.bulkStarThreads(threadIds, true);
        clearSelectionInCard(cardId);
        showUndoToast(threadIds.length + ' threads starred', function() {
            google.script.run.bulkStarThreads(threadIds, false);
        });
    }

    function bulkMarkRead(cardId) {
        var threadIds = Array.from(selectedThreads[cardId] || []);
        if (threadIds.length === 0) return;

        // Update UI immediately
        threadIds.forEach(function(threadId) {
            var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
            if (threadEl) {
                threadEl.classList.remove('unread');
                var badge = threadEl.querySelector('.unread-badge');
                if (badge) badge.remove();
            }
            if (cardData[cardId]) {
                cardData[cardId].groups.forEach(function(g) {
                    g.threads.forEach(function(t) {
                        if (t.threadId === threadId) t.unread = 0;
                    });
                });
            }
        });

        google.script.run.bulkMarkRead(threadIds, true);
        clearSelectionInCard(cardId);
    }

    // Quick reply (inline)
    var currentQuickReply = null;

    function showQuickReply(cardId, threadId, restoreText) {
        // Close any existing quick reply
        closeQuickReply();

        var threadEl = document.querySelector('.thread[data-thread="' + threadId + '"]');
        if (!threadEl) return;

        currentQuickReply = { cardId: cardId, threadId: threadId, threadEl: threadEl };

        // Create inline reply box
        var replyBox = document.createElement('div');
        replyBox.className = 'quick-reply-inline';
        replyBox.id = 'quickReply-' + threadId;
        replyBox.innerHTML = '<div class="quick-reply-loading">Loading...</div>';

        threadEl.classList.add('replying');
        threadEl.appendChild(replyBox);

        // Load thread info
        google.script.run
            .withSuccessHandler(function(info) {
                replyBox.innerHTML =
                    '<div class="quick-reply-context">' +
                    '<div class="quick-reply-from">' + escapeHtml(info.from) + '</div>' +
                    '<div class="quick-reply-body">' + escapeHtml(info.snippet) + '</div>' +
                    '</div>' +
                    '<div class="quick-reply-compose">' +
                    '<textarea class="quick-reply-input" id="quickReplyText" placeholder="Write a reply..."></textarea>' +
                    '<div class="quick-reply-buttons">' +
                    '<button class="quick-reply-cancel" onclick="closeQuickReply()">Cancel</button>' +
                    '<button class="quick-reply-send" onclick="sendQuickReply()">Send</button>' +
                    '</div>' +
                    '</div>';

                var textarea = document.getElementById('quickReplyText');
                if (textarea) {
                    // Restore text if provided
                    if (restoreText) {
                        textarea.value = restoreText;
                    }
                    textarea.focus();
                    // Move cursor to end
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') closeQuickReply();
                        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) sendQuickReply();
                    });
                }
            })
            .withFailureHandler(function(err) {
                replyBox.innerHTML = '<div class="quick-reply-error">Failed to load: ' + escapeHtml(err.message) + '</div>';
            })
            .getThreadForReply(threadId);
    }

    function closeQuickReply() {
        if (!currentQuickReply) return;

        var replyBox = document.getElementById('quickReply-' + currentQuickReply.threadId);
        if (replyBox) replyBox.remove();

        if (currentQuickReply.threadEl) {
            currentQuickReply.threadEl.classList.remove('replying');
        }

        currentQuickReply = null;
    }

    function sendQuickReply() {
        if (!currentQuickReply) return;

        var textarea = document.getElementById('quickReplyText');
        var body = textarea ? textarea.value.trim() : '';

        if (!body) {
            textarea.focus();
            return;
        }

        var sendBtn = document.querySelector('.quick-reply-send');
        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
        }
        if (textarea) textarea.disabled = true;

        var cardId = currentQuickReply.cardId;
        var threadId = currentQuickReply.threadId;

        google.script.run
            .withSuccessHandler(function() {
                closeQuickReply();
                showUndoToast('Reply sent', null);
                refreshCard(cardId);
            })
            .withFailureHandler(function(err) {
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send';
                }
                if (textarea) textarea.disabled = false;
                alert('Failed to send: ' + err.message);
            })
            .sendQuickReply(threadId, body);
    }

    function openCompose(toEmail) {
        var url = "https://mail.google.com/mail/u/0/?view=cm&fs=1&tf=1";
        if (toEmail) url += "&to=" + encodeURIComponent(toEmail);
        window.open(url, "compose", "width=600,height=600");
    }

    var recentRecipients = null, recipientsLoading = false;

    function loadRecentRecipients() {
        if (recentRecipients || recipientsLoading) return;
        recipientsLoading = true;
        google.script.run.withSuccessHandler(function (recipients) { recentRecipients = recipients; recipientsLoading = false; renderComposeMenu(); })
            .withFailureHandler(function () { recipientsLoading = false; document.getElementById("composeMenu").innerHTML = ""; })
            .getRecentRecipients(8);
    }

    function renderComposeMenu() {
        var menu = document.getElementById("composeMenu");
        if (!recentRecipients || recentRecipients.length === 0) { menu.innerHTML = ""; return; }
        var html = "";
        recentRecipients.forEach(function (r) { html += '<div class="compose-menu-item" onclick="openCompose(\'' + escapeHtml(r.email) + '\')"><div class="compose-menu-name">' + escapeHtml(r.name) + '</div><div class="compose-menu-email">' + escapeHtml(r.email) + '</div></div>'; });
        menu.innerHTML = html;
    }

    document.querySelector(".compose-wrapper").addEventListener("mouseenter", loadRecentRecipients);

    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            var sidebar = document.getElementById("settingsSidebar");
            if (sidebar.classList.contains("open")) { toggleSettings(); return; }
            document.querySelectorAll(".card.form-mode").forEach(function (card) { cancelCardForm(card.dataset.id); });
        }
    });

    function formatTime(isoDate) {
        var d = new Date(isoDate), now = new Date();
        var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var dateOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        if (dateOnly.getTime() === today.getTime()) return d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" });
        var yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
        if (dateOnly.getTime() === yesterday.getTime()) return "Yesterday";
        if (d.getFullYear() === now.getFullYear()) return d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
    }

    var pendingNewCard = null;

    function showAddModal() {
        if (pendingNewCard) { var existing = document.querySelector('.card[data-id="' + pendingNewCard.id + '"]'); if (existing) { existing.querySelector(".form-name").focus(); return; } }
        pendingNewCard = { id: "new-" + Date.now(), friendlyName: "", query: "", collapsed: false, order: cards.length, isNew: true };
        var container = document.getElementById("cardRow");
        var addBtn = container.querySelector(".add-card");
        var el = createCardElement(pendingNewCard);
        el.classList.add("form-mode");
        container.insertBefore(el, addBtn);
        setTimeout(function () { var nameInput = el.querySelector(".form-name"); if (nameInput) nameInput.focus(); }, 50);
    }

    var originalCardColors = {};

    function showEditModal(cardId) {
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (!cardEl) return;
        cardEl.classList.add("form-mode");
        var card = cards.find(function (c) { return c.id === cardId; });
        if (card) {
            originalCardColors[cardId] = {
                bgColor: card.bgColor || '',
                bgColorLight: card.bgColorLight || '',
                bgColorDark: card.bgColorDark || '',
                borderColor: card.borderColor || ''
            };
            if (card.query) previewQuery(cardId);
        }
        setTimeout(function () { var queryInput = cardEl.querySelector(".form-query"); if (queryInput) queryInput.focus(); }, 50);
    }

    function cancelCardForm(cardId) {
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (!cardEl) return;
        if (cardId.startsWith("new-")) { cardEl.remove(); pendingNewCard = null; return; }
        cardEl.classList.remove("form-mode");
        var card = cards.find(function (c) { return c.id === cardId; });
        if (card) {
            cardEl.querySelector(".form-name").value = card.friendlyName;
            cardEl.querySelector(".form-query").value = card.query;
            // Restore original colors
            if (originalCardColors[cardId]) {
                var orig = originalCardColors[cardId];
                card.bgColor = orig.bgColor;
                card.bgColorLight = orig.bgColorLight;
                card.bgColorDark = orig.bgColorDark;
                card.borderColor = orig.borderColor;
                var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                var currentColor = isDark ? (orig.bgColorDark || orig.bgColorLight) : orig.bgColorLight;
                cardEl.style.background = currentColor || '';
                cardEl.style.borderColor = orig.borderColor || '';
                if (orig.borderColor) {
                    cardEl.style.setProperty('--card-border-color', orig.borderColor);
                } else {
                    cardEl.style.removeProperty('--card-border-color');
                }
                cardEl.dataset.bgLight = orig.bgColorLight;
                cardEl.dataset.bgDark = orig.bgColorDark;
                cardEl.dataset.borderColor = orig.borderColor;
                var pickerBtn = cardEl.querySelector('.color-picker-selected');
                if (pickerBtn) {
                    pickerBtn.style.background = orig.borderColor || '';
                    pickerBtn.classList.toggle('no-color', !orig.borderColor);
                }
                delete originalCardColors[cardId];
            }
        }
    }

    function saveCardForm(cardId) {
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (!cardEl) return;
        var name = cardEl.querySelector(".form-name").value.trim();
        var query = cardEl.querySelector(".form-query").value.trim();
        var groupByRadio = cardEl.querySelector('input[name="groupby-' + cardId + '"]:checked');
        var groupBy = groupByRadio ? groupByRadio.value : "date";
        if (!name) { cardEl.querySelector(".form-name").focus(); return; }
        if (!query) { cardEl.querySelector(".form-query").focus(); return; }

        var card = cards.find(function (c) { return c.id === cardId; });
        // Also check pendingNewCard for new cards
        if (!card && pendingNewCard && pendingNewCard.id === cardId) {
            card = pendingNewCard;
        }
        var colorData = card ? {
            bgColor: card.bgColor || '',
            bgColorLight: card.bgColorLight || '',
            bgColorDark: card.bgColorDark || '',
            borderColor: card.borderColor || ''
        } : {};

        if (cardId.startsWith("new-")) {
            google.script.run.withSuccessHandler(function (newCard) { cardEl.remove(); pendingNewCard = null; cards.push(newCard); renderCards(); loadThreads(newCard.id); })
                .addCard({ friendlyName: name, query: query, groupBy: groupBy, bgColor: colorData.bgColor, bgColorLight: colorData.bgColorLight, bgColorDark: colorData.bgColorDark, borderColor: colorData.borderColor });
        } else {
            google.script.run.withSuccessHandler(function (updated) {
                var idx = cards.findIndex(function (c) { return c.id === cardId; });
                if (idx !== -1) { cards[idx] = updated; cardData[cardId] = null; }
                cardEl.classList.remove("form-mode");
                cardEl.querySelector(".card-title").textContent = name;
                delete originalCardColors[cardId];
                loadThreads(cardId);
            }).updateCard(cardId, { friendlyName: name, query: query, groupBy: groupBy, bgColor: colorData.bgColor, bgColorLight: colorData.bgColorLight, bgColorDark: colorData.bgColorDark, borderColor: colorData.borderColor });
        }
    }

    function previewQuery(cardId) {
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (!cardEl) return;
        var query = cardEl.querySelector(".form-query").value.trim();
        var groupByRadio = cardEl.querySelector('input[name="groupby-' + cardId + '"]:checked');
        var groupBy = groupByRadio ? groupByRadio.value : "date";
        var preview = document.getElementById("preview-" + cardId);
        if (!query) { preview.innerHTML = '<div class="empty">Enter a query to preview results</div>'; return; }
        preview.innerHTML = '<div class="loading">Searching...</div>';

        google.script.run.withSuccessHandler(function (resp) {
            if (!resp.groups || resp.groups.length === 0) { preview.innerHTML = '<div class="empty">No results</div>'; return; }
            var html = "";
            resp.groups.forEach(function (group) {
                html += '<div class="date-group"><div class="date-header">' + escapeHtml(group.label) + '</div>';
                group.threads.forEach(function (t) {
                    html += '<div class="thread' + (t.unread ? " unread" : "") + '"><div class="thread-row">' + (t.unread ? '<div class="unread-badge"></div>' : '') + '<div class="thread-subject">' + escapeHtml(t.subject) + '</div></div><div class="thread-snippet">' + escapeHtml(t.snippet) + '</div></div>';
                });
                html += '</div>';
            });
            if (resp.count >= 10) html += '<div class="empty">Showing first 10 results</div>';
            preview.innerHTML = html;
        }).withFailureHandler(function (err) { preview.innerHTML = '<div class="empty">Error: ' + escapeHtml(err.message) + '</div>'; }).previewQuery(query, groupBy);
    }

    function confirmDeleteCard(cardId) {
        var card = cards.find(function (c) { return c.id === cardId; });
        if (!card) return;
        if (confirm('Delete "' + card.friendlyName + '"?')) {
            google.script.run.withSuccessHandler(function (updated) { cards = updated; delete cardData[cardId]; renderCards(); }).deleteCard(cardId);
        }
    }

    function escapeHtml(str) { if (!str) return ""; var div = document.createElement("div"); div.textContent = str; return div.innerHTML; }

    var pickerColors = [
        { light: 'rgba(229, 57, 53, 0.30)', dark: 'rgba(229, 57, 53, 0.25)', hex: '#E53935' },       // Red
        { light: 'rgba(251, 140, 0, 0.35)', dark: 'rgba(251, 140, 0, 0.28)', hex: '#FB8C00' },       // Orange
        { light: 'rgba(253, 216, 53, 0.40)', dark: 'rgba(253, 216, 53, 0.28)', hex: '#FDD835' },     // Yellow
        { light: 'rgba(67, 160, 71, 0.35)', dark: 'rgba(67, 160, 71, 0.28)', hex: '#43A047' },       // Green
        { light: 'rgba(0, 172, 193, 0.35)', dark: 'rgba(0, 172, 193, 0.28)', hex: '#00ACC1' },       // Cyan
        { light: 'rgba(30, 136, 229, 0.35)', dark: 'rgba(30, 136, 229, 0.28)', hex: '#1E88E5' },     // Blue
        { light: 'rgba(94, 53, 177, 0.35)', dark: 'rgba(94, 53, 177, 0.30)', hex: '#5E35B1' },       // Deep Purple
        { light: 'rgba(216, 27, 96, 0.30)', dark: 'rgba(216, 27, 96, 0.25)', hex: '#D81B60' }        // Pink
    ];

    function getColorForMode(colorObj) { return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? colorObj.dark : colorObj.light; }

    function buildColorPicker(cardId, currentBorderColor) {
        var hasColor = currentBorderColor && currentBorderColor !== '';
        var selectedStyle = hasColor ? 'background:' + currentBorderColor : '';
        var selectedClass = hasColor ? '' : ' no-color';
        var centerPos = 'left:calc(50% - 11px);top:calc(50% - 11px)';
        var html = '<div class="color-picker" data-card="' + cardId + '">';
        html += '<div class="color-picker-selected' + selectedClass + '" style="' + selectedStyle + '" onclick="toggleColorPicker(this.parentElement)"></div>';
        var radius = 38, numColors = pickerColors.length;
        pickerColors.forEach(function(colorObj, i) {
            var angle = (i / numColors) * 2 * Math.PI - Math.PI / 2;
            var x = radius * Math.cos(angle), y = radius * Math.sin(angle);
            var finalLeft = 'calc(50% + ' + x.toFixed(1) + 'px - 11px)', finalTop = 'calc(50% + ' + y.toFixed(1) + 'px - 11px)';
            // Show solid hex color in picker for better visibility
            html += '<div class="color-option" data-light="' + colorObj.light + '" data-dark="' + colorObj.dark + '" data-hex="' + colorObj.hex + '" data-left="' + finalLeft + '" data-top="' + finalTop + '" style="' + centerPos + ';background:' + colorObj.hex + '" onclick="selectPickerColor(\'' + cardId + '\', this)"></div>';
        });
        var noColorLeft = 'calc(50% + 50px - 11px)', noColorTop = 'calc(50% - 11px)';
        html += '<div class="color-option no-color-option" data-left="' + noColorLeft + '" data-top="' + noColorTop + '" style="' + centerPos + '" onclick="setCardColor(\'' + cardId + '\',\'\',\'\')">';
        html += '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></div>';
        html += '</div>';
        return html;
    }

    function selectPickerColor(cardId, element) { setCardColor(cardId, element.dataset.light, element.dataset.dark, element.dataset.hex); }

    function toggleColorPicker(picker) {
        document.querySelectorAll('.color-picker.open').forEach(function(p) { if (p !== picker) closeColorPicker(p); });
        var isOpening = !picker.classList.contains('open');
        picker.classList.toggle('open');
        var options = picker.querySelectorAll('.color-option');
        if (isOpening) {
            options.forEach(function(opt) { if (opt.dataset.left && opt.dataset.top) { opt.style.left = opt.dataset.left; opt.style.top = opt.dataset.top; } });
            setTimeout(function() { document.addEventListener('click', closeColorPickerOnOutside); }, 0);
        } else {
            options.forEach(function(opt) { opt.style.left = 'calc(50% - 11px)'; opt.style.top = 'calc(50% - 11px)'; });
            document.removeEventListener('click', closeColorPickerOnOutside);
        }
    }

    function closeColorPickerOnOutside(e) { var picker = document.querySelector('.color-picker.open'); if (picker && !picker.contains(e.target)) closeColorPicker(picker); }

    function closeColorPicker(picker) {
        picker.classList.remove('open');
        picker.querySelectorAll('.color-option').forEach(function(opt) { opt.style.left = 'calc(50% - 11px)'; opt.style.top = 'calc(50% - 11px)'; });
        document.removeEventListener('click', closeColorPickerOnOutside);
    }

    function setCardColor(cardId, lightColor, darkColor, hexColor) {
        var card = cards.find(function(c) { return c.id === cardId; });
        // Also check pendingNewCard for new cards
        if (!card && pendingNewCard && pendingNewCard.id === cardId) {
            card = pendingNewCard;
        }
        if (!card) return;
        card.bgColorLight = lightColor || '';
        card.bgColorDark = darkColor || '';
        card.bgColor = lightColor || '';
        card.borderColor = hexColor || '';
        var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var currentColor = isDark ? (darkColor || '') : (lightColor || '');
        var cardEl = document.querySelector('.card[data-id="' + cardId + '"]');
        if (cardEl) {
            if (currentColor) {
                cardEl.style.background = currentColor;
                cardEl.style.borderColor = hexColor || '';
                cardEl.style.setProperty('--card-border-color', hexColor || '');
                cardEl.dataset.bgLight = lightColor || '';
                cardEl.dataset.bgDark = darkColor || '';
                cardEl.dataset.borderColor = hexColor || '';
            } else {
                cardEl.style.background = '';
                cardEl.style.borderColor = '';
                cardEl.style.removeProperty('--card-border-color');
                cardEl.dataset.bgLight = '';
                cardEl.dataset.bgDark = '';
                cardEl.dataset.borderColor = '';
            }
            var pickerBtn = cardEl.querySelector('.color-picker-selected');
            if (pickerBtn) {
                if (hexColor) { pickerBtn.style.background = hexColor; pickerBtn.classList.remove('no-color'); }
                else { pickerBtn.style.background = ''; pickerBtn.classList.add('no-color'); }
            }
        }
        var picker = cardEl ? cardEl.querySelector('.color-picker') : null;
        if (picker) picker.classList.remove('open');
        // Color is saved when form is submitted, not here
    }

    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            var isDark = e.matches;
            document.querySelectorAll('.card').forEach(function(cardEl) {
                var lightColor = cardEl.dataset.bgLight, darkColor = cardEl.dataset.bgDark;
                if (lightColor || darkColor) {
                    cardEl.style.background = isDark ? (darkColor || '') : (lightColor || '');
                    var pickerBtn = cardEl.querySelector('.color-picker-selected');
                    if (pickerBtn) pickerBtn.style.background = isDark ? (darkColor || '') : (lightColor || '');
                }
            });
            // Color options always show solid hex color regardless of theme
        });
    }

    function formatFileSize(bytes) {
        if (!bytes) return '';
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getAttachmentIcon(contentType) {
        contentType = contentType || '';
        if (contentType.indexOf('pdf') !== -1) return '<svg class="attachment-icon" viewBox="0 0 24 24" fill="#c00"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>';
        if (contentType.indexOf('image/') === 0) return '<svg class="attachment-icon" viewBox="0 0 24 24" fill="#090"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
        if (contentType.indexOf('document') !== -1 || contentType.indexOf('msword') !== -1) return '<svg class="attachment-icon" viewBox="0 0 24 24" fill="#06c"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
        if (contentType.indexOf('spreadsheet') !== -1 || contentType.indexOf('excel') !== -1) return '<svg class="attachment-icon" viewBox="0 0 24 24" fill="#090"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>';
        if (contentType.indexOf('zip') !== -1 || contentType.indexOf('compressed') !== -1 || contentType.indexOf('archive') !== -1) return '<svg class="attachment-icon" viewBox="0 0 24 24" fill="#960"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-2 6h-2v2h2v2h-2v2h-2v-2h2v-2h-2v-2h2v-2h-2V8h2v2h2v2z"/></svg>';
        return '<svg class="attachment-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>';
    }

    init();
</script>